<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <link rel="icon" href="resource/icon.ico" />
    <title>Client Form</title>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.js"></script>

    <link
      href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css"
      rel="stylesheet"
    />
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        padding: 20px;
      }
      .lbl2Left {
        min-width: 110px;
        padding-left: 15px;
      }
      .lbl2Right {
        min-width: 150px;
        padding-left: 15px;
      }
      .bold-text {
        font-weight: bold;
      }
      .input-disabled {
        background-color: #fff !important;
      }
    </style>
  </head>
  <body class="container mt-5">
    <div class="row align-items-end mb-3">
      <div class="col-md-4">
        <img src="resource/logo.png" class="img-fluid" alt="Prospine" />
      </div>
      <div class="col-md-4 text-center">
        <h1>Growth Taller Form</h1>
      </div>
    </div>

    <div id="userForm" class="row">
      <div class="col-md-6">
        <h3 id="formTitle">Add New Client</h3>
        <form id="inputForm" class="mb-4">
          <input type="hidden" id="userId" name="userId" />
          <input type="hidden" id="userCreatedAt" name="userCreatedAt" />
          <div class="form-row">
            <div class="form-group col-md-8">
              <label for="name">Name :</label>
              <input
                type="text"
                id="name"
                name="name"
                class="form-control"
                maxlength="40"
                required
              />
            </div>
            <div class="form-group col-md-4">
              <label for="dob">Date of Birth :</label>
              <input
                type="date"
                id="dob"
                name="dob"
                class="form-control"
                required
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-4">
              <label for="phone">Phone No. :</label>
              <input
                type="number"
                id="phone"
                name="phone"
                class="form-control"
                min="99999999"
                max="9999999999999"
                required
              />
            </div>
            <div class="form-group col-md-3">
              <label for="gender">Gender:</label>
              <select id="gender" name="gender" class="form-control" required>
                <option value="M">Male</option>
                <option value="F">Female</option>
              </select>
            </div>
            <div class="form-group col-md-2">
              <label for="height">Age :</label>
              <input
                type="number"
                id="age"
                name="age"
                class="form-control"
                min="1"
                max="999"
                disabled
              />
            </div>
            <div class="form-group col-md-3">
              <label for="branch">Branch :</label>
              <select class="form-control" id="branch" name="branch" required>
                <option value="Tangerang">Tangerang</option>
                <option value="Surabaya">Surabaya</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-4">
              <label for="height">Height (cm) :</label>
              <input
                type="number"
                id="height"
                name="height"
                class="form-control"
                min="1"
                max="999"
                step=".01"
                required
              />
            </div>
            <div class="form-group col-md-4">
              <label for="dadHeight">Dad Height (cm) :</label>
              <input
                type="number"
                id="dadHeight"
                name="dadHeight"
                class="form-control"
                min="1"
                max="999"
                step=".01"
                required
              />
            </div>
            <div class="form-group col-md-4">
              <label for="momHeight">Mom Height (cm) :</label>
              <input
                type="number"
                id="momHeight"
                name="momHeight"
                class="form-control"
                min="1"
                max="999"
                step=".01"
                required
              />
            </div>
          </div>
          <div class="form-group">
            <button
              type="button"
              id="generate"
              name="generate"
              class="btn btn-primary"
            >
              Generate Chart
            </button>
          </div>
          <div class="form-group">
            <label for="notes">Notes :</label>
            <textarea
              id="notes"
              name="notes"
              class="form-control"
              rows="9"
              maxlength="560"
              wrap="hard"
              style="resize: none"
            ></textarea>
          </div>

          <button type="submit" class="btn btn-primary" id="saveClientButton">
            Save Client Data
          </button>
          <button type="button" class="btn btn-secondary" id="goBackButton">
            Go Back
          </button>
        </form>
      </div>
      <div class="col-md-6">
        <div id="userProgress">
          <h3 id="progressTitle">Progress</h3>
          <form id="progressForm" class="form-inline mb-2">
            <label for="progressHeight">Height (cm) :</label>
            <input
              type="number"
              id="progressHeight"
              class="form-control mx-2 col-md-3"
              required
            />
            <label for="progressDate">Date :</label>
            <input
              type="date"
              id="progressDate"
              class="form-control mx-2"
              required
            />
            <button type="button" id="saveProgress" class="btn btn-primary">
              Submit
            </button>
          </form>
        </div>
        <div id="userLastProgress">
          <h6 id="lastProgressTitle">Last Progress Record</h6>
          <form id="lastProgressRecordForm" class="form-inline mb-2">
            <label for="lastProgressHeight">Height (cm) :</label>
            <input
              type="number"
              id="lastProgressHeight"
              class="form-control mx-2 col-md-3"
              disabled
              value="0"
            />
            <label for="lastProgressDate">Date :</label>
            <input
              type="date"
              id="lastProgressDate"
              class="form-control mx-2"
              disabled
            />
          </form>
        </div>
        <div>
          <label for="chart">Potential Growth</label>
        </div>
        <div class="border p-1">
          <canvas id="myChart" width="400" height="400"></canvas>
        </div>
        <div class="mt-3">
          <button id="resetZoom" class="btn btn-secondary">Reset Zoom</button>
          <button id="saveToPDF" class="btn btn-primary">Save to PDF</button>
        </div>
      </div>
      <div id="userProgressList" class="mt-4 col-md-12">
        <h2 class="mb-3">Client Progress Data</h2>

        <table
          id="userProgressTable"
          class="table table-striped table-bordered"
        >
          <thead>
            <tr>
              <th>Record Date</th>
              <th>Height</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <script>
      const host = "https://prospine.id:8443";
      // const host = "http://localhost:8585";

      const chartOptions = {
        scales: {
          x: {
            type: "time",
            time: {
              unit: "year",
              tooltipFormat: "dd MMM yyyy",
            },
            title: {
              display: true,
              text: "Year",
            },
            ticks: {
              // callback: function (val, index) {
              //   var label = this.getLabelForValue(val);
              // },
              minRotation: 0,
              maxRotation: 0,
            },
          },
          y: {
            title: {
              display: true,
              text: "Height (cm)", // Y-axis label
            },
            beginAtZero: false, // Allow non-zero start for y-axis
          },
        },
        plugins: {
          datalabels: {
            font: {
              lineHeight: 1.5,
              weight: "bold",
            },
            formatter: function (value, context) {
              if (context.dataIndex === context.dataset.data.length - 1) {
                return "\n" + value.y + "      ";
              }
              return "";
            },
          },
          zoom: {
            pan: {
              enabled: true,
              mode: "xy",
            },
            zoom: {
              wheel: {
                enabled: true,
              },
              mode: "xy",
            },
          },
        },
        devicePixelRatio: 2,
      };

      $(document).on("keydown", ":input:not(textarea)", function (event) {
        if (event.key == "Enter") {
          event.preventDefault();
        }
      });

      $(document).ready(function () {
        document.getElementById("dob").addEventListener("change", function () {
          const dob = new Date(this.value);
          const today = new Date();
          let age = today.getFullYear() - dob.getFullYear();
          const monthDiff = today.getMonth() - dob.getMonth();

          if (
            monthDiff < 0 ||
            (monthDiff === 0 && today.getDate() < dob.getDate())
          ) {
            age--;
          }

          document.getElementById("age").value = age;
        });

        var urlParams = new URLSearchParams(window.location.search);
        var userId = urlParams.get("id");
        console.log("userId param", userId);

        document.getElementById("userCreatedAt").value = formatDate(new Date());
        document.getElementById("lastProgressHeight").value = 0;
        document.getElementById("lastProgressDate").value = null;

        const userProgress = document.getElementById("userProgress");
        const userLastProgress = document.getElementById("userLastProgress");
        const userProgressList = document.getElementById("userProgressList");
        if (userId) {
          // Edit user scenario
          $("#formTitle").text("Edit Client");
          $("#saveClientButton").text("Update Client Data");
          document.getElementById("progressDate").valueAsDate = new Date();

          // Fetch the user details and populate the form
          $.ajax({
            type: "GET",
            url: `${host}/userById`,
            data: { id: userId },
            success: async function (data) {
              $("#userId").val(data.id);
              $("#userCreatedAt").val(formatDate(new Date(data.createdAt)));
              $("#branch").val(data.branch);
              $("#name").val(data.name);
              $("#dob").val(data.dateOfBirth);
              $("#age").val(data.age);
              $("#phone").val(data.phone);
              $("#gender").val(data.gender);
              $("#height").val(data.height);
              $("#dadHeight").val(data.dadHeight);
              $("#momHeight").val(data.momHeight);
              $("#notes").val(data.notes);

              var ages = [];
              var heightDataMin = [];
              var heightDataAvg = [];
              var heightDataMax = [];

              console.log(
                `calculate dadHeight: ${data.dadHeight} momHeight: ${data.momHeight} gender: ${data.gender}`
              );
              await fetch(
                `${host}/calculateGrowth?dadHeight=${data.dadHeight}&momHeight=${data.momHeight}&gender=${data.gender}`,
                {
                  method: "GET",
                  headers: {
                    "Content-Type": "application/json",
                  },
                }
              )
                .then((response) => response.json())
                .then((progressData) => {
                  console.log("Success calculateGrowth: ", progressData);
                  for (var i = 0; i < progressData.length; i++) {
                    ages.push(progressData[i].age.toString());
                    heightDataMin.push(progressData[i].minHeight);
                    heightDataAvg.push(progressData[i].avgHeight);
                    heightDataMax.push(progressData[i].maxHeight);
                  }
                })
                .catch((error) => {
                  console.error("Error:", error);
                });

              await updateChart(
                ages,
                heightDataMin,
                heightDataAvg,
                heightDataMax
              );

              await fetch(
                `${host}/latestProgressRecordById?userId=${data.id}`,
                {
                  method: "GET",
                  headers: {
                    "Content-Type": "application/json",
                  },
                }
              )
                .then((response) => response.json())
                .then((lastProgressData) => {
                  console.log(
                    "Success get latestProgressRecordById: ",
                    lastProgressData
                  );

                  if (!lastProgressData) return;

                  document.getElementById("lastProgressHeight").value =
                    lastProgressData.height;
                  document.getElementById("lastProgressDate").value =
                    lastProgressData.recordDate;
                })
                .catch((error) => {
                  console.error("Error:", error);
                });

              await loadProgressListTable();
            },
            error: function () {
              alert("Error fetching user details");
            },
          });
        } else {
          userProgress.style.display = "none";
          userLastProgress.style.display = "none";
          userProgressList.style.display = "none";
        }

        function handleSaveClient(event) {
          event.preventDefault();
          console.log("event", event);
          console.log("submit here");
          var dob = $("#dob").val();
          console.log("dob here", dob);

          var formData = {
            branch: $("#branch").val(),
            name: $("#name").val(),
            dateOfBirth: dob,
            age: $("#age").val(),
            phone: $("#phone").val(),
            gender: $("#gender").val(),
            height: $("#height").val(),
            dadHeight: $("#dadHeight").val(),
            momHeight: $("#momHeight").val(),
            notes: $("#notes").val(),
          };

          $.ajax({
            type: "POST",
            url: `${host}/userExistsByNameAndPhone`,
            data: JSON.stringify({
              name: formData.name,
              phone: formData.phone,
            }),
            contentType: "application/json",
            success: function (result) {
              console.log("duplicate result", result);

              if (!userId && result) {
                alert(
                  "A user with the same name and phone number already exists."
                );
                return;
              }

              var ajaxUrl = userId
                ? `${host}/submitFormData/${userId}`
                : `${host}/submitFormData`;
              var ajaxMethod = userId ? "PUT" : "POST";

              $.ajax({
                type: ajaxMethod,
                url: ajaxUrl,
                data: JSON.stringify(formData),
                contentType: "application/json",
                success: function (result) {
                  console.log("result save", result);
                  alert(
                    "User " + (userId ? "updated" : "added") + " successfully"
                  );

                  if (!userId && ajaxMethod === "POST") {
                    window.location.href = "userForm.html?id=" + result;
                  } else {
                    location.reload();
                  }
                },
                error: function () {
                  alert(
                    "Error " + (userId ? "updating" : "adding") + " client"
                  );
                },
              });
            },
            error: function () {
              alert("Error checking for duplicate user.");
            },
          });
        }

        const userForm = document.getElementById("userForm");
        userForm.addEventListener("submit", handleSaveClient);

        // $("#saveClientButton").keydown(function (event) {
        //   event.preventDefault();
        // });
      });

      $("#goBackButton").click(function () {
        window.location.href = "index.html";
      });

      async function generateChart() {
        var height = document.getElementById("height").value;
        var dob = document.getElementById("dob").value;
        var age = document.getElementById("age").value;
        var gender = document.getElementById("gender").value;
        var dadHeight = document.getElementById("dadHeight").value;
        var momHeight = document.getElementById("momHeight").value;

        var ages = [];
        var heightDataMin = [];
        var heightDataAvg = [];
        var heightDataMax = [];
        var initialHeightData = [];

        console.log(
          `calculate dadHeight: ${dadHeight} momHeight: ${momHeight} gender: ${gender}`
        );
        await fetch(
          `${host}/calculateGrowth?dadHeight=${dadHeight}&momHeight=${momHeight}&gender=${gender}`,
          {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          }
        )
          .then((response) => response.json())
          .then((data) => {
            console.log("Success calculateGrowth: ", data);
            for (var i = 0; i < data.length; i++) {
              ages.push(data[i].age.toString());
              heightDataMin.push(data[i].minHeight);
              heightDataAvg.push(data[i].avgHeight);
              heightDataMax.push(data[i].maxHeight);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
          });

        await updateChart(ages, heightDataMin, heightDataAvg, heightDataMax);
      }

      document
        .getElementById("generate")
        .addEventListener("click", async function (event) {
          event.preventDefault();
          await generateChart();
        });

      function getBirtdays(dobString) {
        var dob = new Date(dobString);
        var year = dob.getFullYear();

        var birthdays = [];

        for (var age = 2; age <= 20; age++) {
          var birthday = new Date(dob);
          birthday.setFullYear(year + age);
          // birthday.setMonth(0);
          // birthday.setDate(1);
          birthdays.push(birthday.toISOString().split("T")[0]);
        }

        return birthdays;
      }

      async function updateChart(
        ages,
        heightDataMin,
        heightDataAvg,
        heightDataMax
      ) {
        var heightProgress = [];
        var heightProg = [];
        var userId = $("#userId").val();

        var initialHeight = document.getElementById("height").value;
        var dob = document.getElementById("dob").value;
        var age = document.getElementById("age").value;
        var firstProgressYear =
          heightProgress.length > 0
            ? new Date(heightProgress[0].date).getFullYear()
            : 0;

        var userCreatedAt = document.getElementById("userCreatedAt").value;
        heightProg.push({
          x: formatDate(userCreatedAt),
          y: initialHeight,
        });

        if (userId) {
          await fetch(`${host}/userProgressById?userId=${userId}`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              for (var i = 0; i < data.length; i++) {
                var progress = {
                  height: data[i].height,
                  date: data[i].recordDate,
                };
                heightProgress.push(progress);

                heightProg.push({
                  x: data[i].recordDate,
                  y: data[i].height,
                });
              }
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        }
        console.log("heightProgress: ", heightProgress);

        var progressPoint = heightProg.length > 1 ? false : true;

        var dataMin = [];
        var dataAvg = [];
        var dataMax = [];

        var birthdays = getBirtdays(dob);

        for (var i = 0; i < birthdays.length; i++) {
          dataMin.push({
            x: birthdays[i],
            y: heightDataMin[i],
          });

          dataAvg.push({
            x: birthdays[i],
            y: heightDataAvg[i],
          });

          dataMax.push({
            x: birthdays[i],
            y: heightDataMax[i],
          });
        }

        var data = {
          datasets: [
            {
              label: "Min",
              data: dataMin,
              backgroundColor: "rgba(54, 162, 235, 0.2)",
              borderColor: "rgba(54, 162, 235, 1)",
              borderWidth: 1,
              spanGaps: true,
              pointStyle: false,
              tension: 0.4,
            },
            {
              label: "Avg",
              data: dataAvg,
              backgroundColor: "rgba(204, 153, 255, 0.2)",
              borderColor: "rgba(204, 153, 255, 1)",
              borderWidth: 1,
              spanGaps: true,
              pointStyle: false,
              tension: 0.4,
            },
            {
              label: "Max",
              data: dataMax,
              backgroundColor: "rgba(75, 192, 192, 0.2)",
              borderColor: "rgba(75, 192, 192, 1)",
              borderWidth: 1,
              spanGaps: true,
              pointStyle: false,
              tension: 0.4,
            },
            {
              label: "Height",
              data: heightProg,
              backgroundColor: "rgba(255, 99, 132, 0.2)",
              borderColor: "rgba(255, 99, 132, 1)",
              borderWidth: 2,
              spanGaps: true,
              pointStyle: progressPoint,
              tension: 0.2,
            },
          ],
        };

        if (window.myChart instanceof Chart) {
          window.myChart.resetZoom();
          window.myChart.destroy(); // Destroy the existing chart
        }

        // Create a new chart instance
        var chartCtx = document.getElementById("myChart").getContext("2d");
        window.myChart = new Chart(chartCtx, {
          type: "line",
          data: data,
          plugins: [ChartDataLabels],
          options: chartOptions,
        });
      }

      document
        .getElementById("saveProgress")
        .addEventListener("click", async function (event) {
          event.preventDefault();

          var ages = [];
          var heightDataMin = [];
          var heightDataAvg = [];
          var heightDataMax = [];

          var userId = document.getElementById("userId").value;
          var name = document.getElementById("name").value;
          var phone = document.getElementById("phone").value;
          var updatedHeight = parseFloat(
            document.getElementById("progressHeight").value
          );
          var dadHeight = document.getElementById("dadHeight").value;
          var momHeight = document.getElementById("momHeight").value;
          var gender = document.getElementById("gender").value;
          var progressDate = document.getElementById("progressDate").value;

          if (
            !userId ||
            !name ||
            !phone ||
            !dadHeight ||
            !momHeight ||
            !gender ||
            !updatedHeight ||
            !progressDate
          ) {
            alert("Forms cannot be empty.");
            return;
          }

          await fetch(`${host}/userProgress`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              userId: userId,
              height: updatedHeight,
              recordDate: progressDate,
            }),
          })
            .then((response) => {
              console.log("Success");
              alert("Updated user height progress.");
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("Failed to update user height progress.");
            });

          await fetch(
            `${host}/calculateGrowth?dadHeight=${dadHeight}&momHeight=${momHeight}&gender=${gender}`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            }
          )
            .then((response) => response.json())
            .then((data) => {
              console.log("Success calculateGrowth: ", data);
              for (var i = 0; i < data.length; i++) {
                ages.push(data[i].age.toString());
                heightDataMin.push(data[i].minHeight);
                heightDataAvg.push(data[i].avgHeight);
                heightDataMax.push(data[i].maxHeight);
              }
            })
            .catch((error) => {
              console.error("Error:", error);
            });

          await updateChart(ages, heightDataMin, heightDataAvg, heightDataMax);

          // await fetch(`${host}/latestProgressRecordById?userId=${userId}`, {
          //   method: "GET",
          //   headers: {
          //     "Content-Type": "application/json",
          //   },
          // })
          //   .then((response) => response.json())
          //   .then((lastProgressData) => {
          //     console.log(
          //       "Success get latestProgressRecordById: ",
          //       lastProgressData
          //     );

          //     document.getElementById("lastProgressHeight").value =
          //       lastProgressData.height;
          //     document.getElementById("lastProgressDate").value =
          //       lastProgressData.recordDate;
          //   })
          //   .catch((error) => {
          //     console.error("Error:", error);
          //   });

          await loadProgressListTable();
        });

      function formatDate(date) {
        var d = new Date(date),
          month = "" + (d.getMonth() + 1),
          day = "" + d.getDate(),
          year = d.getFullYear();

        if (month.length < 2) month = "0" + month;
        if (day.length < 2) day = "0" + day;

        return [year, month, day].join("-");
      }

      document
        .getElementById("saveToPDF")
        .addEventListener("click", async function () {
          // Get form data
          var urlParams = new URLSearchParams(window.location.search);
          var userId = urlParams.get("id");
          var userCreatedAt = document.getElementById("userCreatedAt").value;
          var branch = document.getElementById("branch").value;
          var name = document.getElementById("name").value;
          var dob = document.getElementById("dob").value;
          var age = document.getElementById("age").value;
          var phone = document.getElementById("phone").value;
          var height = document.getElementById("height").value;
          var gender = document.getElementById("gender").value;
          var dadHeight = document.getElementById("dadHeight").value;
          var momHeight = document.getElementById("momHeight").value;
          var notes = document.getElementById("notes").value;
          var lastProgressHeight;
          var lastProgressDate;

          await fetch(`${host}/latestProgressRecordById?userId=${userId}`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((response) => response.json())
            .then((lastProgressData) => {
              console.log(
                "Success get latestProgressRecordById: ",
                lastProgressData
              );

              if (!lastProgressData) return;

              lastProgressHeight = lastProgressData.height;
              lastProgressDate = lastProgressData.recordDate;
            })
            .catch((error) => {
              console.error("Error:", error);
            });

          var lastHeight = lastProgressHeight > 0 ? lastProgressHeight : "-";
          var lastHeightDate = lastProgressDate ? lastProgressDate : "-";

          if (!name || !dob || !phone || !dadHeight || !momHeight || !gender) {
            alert("Form fields can't be empty");
            return;
          }

          var userData = {
            userCreatedAt,
            branch,
            name,
            dob,
            age,
            phone,
            height,
            gender,
            dadHeight,
            momHeight,
            notes,
            lastHeight,
            lastHeightDate,
          };

          var userProgressRows = [];

          if (userId) {
            await fetch(`${host}/userProgressById?userId=${userId}`, {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            })
              .then((response) => response.json())
              .then((lastProgressData) => {
                for (var i = 0; i < lastProgressData.length; i++) {
                  var data = lastProgressData[i];
                  console.log("data", data);
                  var row = [i + 1, data.recordDate, data.height];
                  userProgressRows.push(row);
                }
              })
              .catch((error) => {
                console.error("Error:", error);
              });
          }

          // Get chart data
          let canvas = document.getElementById("myChart");

          // Generate PDF
          generatePdf(userData, userProgressRows, canvas);
        });

      function generatePdf(userData, userProgressRows, canvas) {
        var newCanvas = canvas.cloneNode(true);
        var ctx = newCanvas.getContext("2d");

        // Create linear gradient
        const grad = ctx.createLinearGradient(0, 0, newCanvas.width, 0);
        grad.addColorStop(0, "#b7f4ae");
        grad.addColorStop(1, "#eafcd2");

        // ctx.fillStyle = "#d8f8c6";
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, newCanvas.width, newCanvas.height);
        ctx.drawImage(canvas, 0, 0);
        const chartDataUrl = newCanvas.toDataURL("image/jpeg");

        var pdf = new jspdf.jsPDF("p", "mm", "a5");

        function drawTextWithRect(text, x, y, width) {
          pdf.setFont(undefined, "normal").text(text, x + 1, y);
          // pdf.setFont(undefined, "normal").text(text, x + 1, y + 5);
          // pdf.rect(x, y, width, 7);
        }

        function printHeader() {
          var logo = new Image();
          logo.src = "resource/logo.png";
          pdf.addImage(logo, "PNG", 5, 4, 25, 10);

          pdf
            .setFont(undefined, "bold")
            .setFontSize(14)
            .text("GROWTH TALLER RESULT", 40, 10);

          pdf
            .setFont(undefined, "normal")
            .setFontSize(10)
            .text(formatDate(new Date()), 120, 10);
        }

        printHeader();

        pdf.setFontSize(11);

        var initY = 18;
        var lineDiff = 6;

        function getY(lineNo) {
          return initY + lineDiff * lineNo;
        }

        var lineY = getY(1);
        pdf
          .setFont(undefined, "bold")
          .text(`Name`, 10, lineY)
          .text(`:`, 22, lineY);
        drawTextWithRect(`${userData.name}`, 24, lineY, 62);

        var half = pdf.internal.pageSize.getWidth() / 2;
        var colonRight = half + 39;
        var textRight = colonRight + 2;
        console.log("half", half);

        pdf
          .setFont(undefined, "bold")
          .text(`Branch`, half, lineY)
          .text(`:`, colonRight, lineY);
        drawTextWithRect(`${userData.branch}`, textRight, lineY, 62);

        lineY = getY(2);
        pdf
          .setFont(undefined, "bold")
          .text(`Current Age`, 10, lineY)
          .text(`:`, 53, lineY);
        drawTextWithRect(`${userData.age}`, 55, lineY, 32);

        pdf
          .setFont(undefined, "bold")
          .text(`Date of Birth`, half, lineY)
          .text(`:`, colonRight, lineY);
        drawTextWithRect(`${userData.dob}`, textRight, lineY, 10);

        lineY = getY(3);
        pdf
          .setFont(undefined, "bold")
          .text(`First Recorded Height`, 10, lineY)
          .text(`:`, 53, lineY);
        drawTextWithRect(`${userData.height}`, 55, lineY, 15);

        pdf
          .setFont(undefined, "bold")
          .text(`First Recorded Date`, half, lineY)
          .text(`:`, colonRight, lineY);
        drawTextWithRect(`${userData.userCreatedAt}`, textRight, lineY, 6);

        lineY = getY(4);
        pdf
          .setFont(undefined, "bold")
          .text(`Last Recorded Height`, 10, lineY)
          .text(`:`, 53, lineY);
        drawTextWithRect(`${userData.lastHeight}`, 55, lineY, 15);

        pdf
          .setFont(undefined, "bold")
          .text(`Last Recorded Date`, half, lineY)
          .text(`:`, colonRight, lineY);
        drawTextWithRect(`${userData.lastHeightDate}`, textRight, lineY, 15);

        lineY = getY(5);
        // pdf.setFillColor("#e6fcce");
        // pdf.rect(10, lineY, 120, 100, "F");

        // pdf.setFont(undefined, "bold").text("Growth Chart", 10, lineY);
        pdf.addImage(chartDataUrl, "PNG", 10, lineY, 127, 116);

        var watermark = new Image();
        watermark.src = "resource/watermark.png";
        pdf.addImage(watermark, "PNG", 25, 85, 107, 43);

        pdf
          .setFont(undefined, "bold")
          .text("Notes:", 10, 170)
          .setFont(undefined, "normal")
          .text(userData.notes, 10, 175, { maxWidth: 120 });
        // pdf.rect(10, 77, 124, 130);

        function printFooter() {
          pdf.setFontSize(8);

          lineY = 200;
          pdf
            .setFont(undefined, "bold")
            .text(`Phone (Tangerang) :`, 8, lineY)
            .setFont(undefined, "normal")
            .text("0812-9567-2727", 36, lineY);

          pdf
            .setFont(undefined, "bold")
            .text(`Phone (Surabaya) :`, 59, lineY)
            .setFont(undefined, "normal")
            .text("0813-3643-7777", 85, lineY);

          pdf
            .setFont(undefined, "bold")
            .text(`E-Mail :`, 108, lineY)
            .setFont(undefined, "normal")
            .text("info@prospine.id", 119, lineY);

          lineY = 205;
          var imageLineY = lineY - 3;

          var instagram = new Image();
          instagram.src = "resource/instagram.png";
          pdf.addImage(instagram, "PNG", 15, imageLineY, 4, 4);
          pdf.setFont(undefined, "normal").text("prospine.clinic", 21, lineY);

          var tiktok = new Image();
          tiktok.src = "resource/tiktok.png";
          pdf.addImage(tiktok, "PNG", 45, imageLineY, 4, 4);
          pdf.setFont(undefined, "normal").text("prospine.clinic", 51, lineY);

          var youtube = new Image();
          youtube.src = "resource/youtube.png";
          pdf.addImage(youtube, "PNG", 75, imageLineY, 4, 4);
          pdf.setFont(undefined, "normal").text("Prospine Clinic", 81, lineY);

          var website = new Image();
          website.src = "resource/website.png";
          pdf.addImage(website, "PNG", 105, imageLineY, 4, 4);
          pdf.setFont(undefined, "normal").text("www.prospine.id", 111, lineY);
        }

        printFooter();

        if (userProgressRows.length > 0) {
          pdf.addPage();

          //TODO: Record History
          var columns = ["No.", "Record Date", "Height"];
          pdf.autoTable({
            head: [columns],
            body: userProgressRows,
            didDrawPage: function (data) {
              printHeader();
              pdf
                .setFont(undefined, "bold")
                .setFontSize(12)
                .text(
                  "Record History",
                  pdf.internal.pageSize.getWidth() / 2,
                  25,
                  { align: "center" }
                );
              printFooter();
            },
            margin: {
              top: 30,
              bottom: 15,
            },
          });
        }

        pdf.save("growth_taller.pdf");
      }

      document
        .getElementById("resetZoom")
        .addEventListener("click", function () {
          if (window.myChart instanceof Chart) {
            window.myChart.resetZoom();
          }
        });

      async function loadProgressListTable() {
        var urlParams = new URLSearchParams(window.location.search);
        var userId = urlParams.get("id");
        console.log("userId", userId);

        if ($.fn.DataTable.isDataTable("#userProgressTable")) {
          $("#userProgressTable").DataTable().destroy();
        }

        $("#userProgressTable").DataTable({
          ajax: {
            url: `${host}/userProgressById?userId=${userId}`,
            dataSrc: "",
          },
          columns: [
            { data: "recordDate" },
            { data: "height" },
            {
              data: null,
              defaultContent:
                "<button class='delete-btn btn btn-danger btn-sm'>Delete</button>",
              orderable: false,
            },
          ],
          pagingType: "simple_numbers",
          language: {
            emptyTable: "No data available",
            paginate: {
              previous: "&laquo;",
              next: "&raquo;",
            },
          },
          layout: {
            topStart: "search",
            topEnd: "pageLength",
            bottomStart: "paging",
            bottomEnd: "info",
          },
        });

        $("#userProgressTable tbody").on("click", ".delete-btn", function () {
          var table = $("#userProgressTable").DataTable();
          var data = table.row($(this).parents("tr")).data();
          console.log("data", data);
          var recordId = data.id;

          if (confirm("Are you sure you want to delete this record?")) {
            $.ajax({
              url: `${host}/userProgressById/${recordId}`,
              type: "DELETE",
              success: async function (result) {
                table.ajax.reload();
                await generateChart();
              },
              error: function (xhr, status, error) {
                alert("Error deleting record: " + xhr.responseText);
              },
            });
          }
        });
      }
    </script>
  </body>
</html>
